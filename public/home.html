<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>La Desesperanza - Inventario</title>
  <link rel="stylesheet" href="/style.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="home-page">
  <header class="d-flex justify-content-between align-items-center p-3 bg-dark text-white">
    <h1 class="m-0">La Desesperanza</h1>
    <div>
      <button id="btn-cerrar-sesion" class="btn btn-outline-light btn-sm">Cerrar sesión</button>
    </div>
  </header>

  <main class="container mt-4">
    <div class="content-wrapper">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>Catálogo de panes</h2>
      <div>
        <button id="btn-agregar" class="btn btn-success">Agregar nuevo pan (Admin)</button>
      </div>
    </div>

    <div id="galeria" class="d-flex flex-wrap gap-3"></div>

    <hr>
    <div id="seccion-carrito" class="mb-4">
      <h3>Carrito</h3>
      <div id="lista-carrito" class="mb-3 border p-3 rounded">
        <p class="text-muted">Carrito vacío</p>
      </div>
      <div id="resumen-carrito">
        <div class="d-flex justify-content-between align-items-center border-top pt-3">
          <p class="h5 mb-0">Total: $<span id="total-carrito">0.00</span></p>
          <div>
            <button id="btn-comprar" class="btn btn-primary" disabled>Realizar compra</button>
          </div>
        </div>
      </div>
    </div>
    
    <hr>
    <!-- Mis fondos (solo para usuarios normales) -->
    <section id="fondos-section" style="display:none; margin-bottom:30px; max-width:500px;">
      <h3>Fondos</h3>
      <div class="input-group">
        <input type="number" id="input-cantidad-fondos" class="form-control" placeholder="Cantidad a añadir" min="0.01" step="0.01">
        <button class="btn btn-primary" id="btn-sumar-fondos">Sumar fondos</button>
      </div>
      <small class="text-muted d-block mt-2">Máximo permitido: $999,999,999,999</small>
    </section>

    <hr>
    <!-- Sucursales -->
    <section id="seccion-sucursales" class="mb-5">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Nuestras sucursales</h2>
        <div id="admin-sucursal-actions"></div>
      </div>
      <div id="map" style="height: 420px; border-radius:8px; overflow:hidden;"></div>
      <!-- Formulario admin para agregar sucursales (se muestra solo a admin) -->
      <div id="form-sucursal" style="display:none; margin-top:12px; max-width:520px;">
        <h5>Agregar sucursal (Admin)</h5>
        <div class="mb-2"><label>Nombre</label><input id="sucursal-nombre" class="form-control"></div>
        <div class="mb-2"><label>Latitud</label><input id="sucursal-lat" class="form-control" placeholder="ej. -34.6037"></div>
        <div class="mb-2"><label>Longitud</label><input id="sucursal-lng" class="form-control" placeholder="ej. -58.3816"></div>
        <div><button id="btn-guardar-sucursal" class="btn btn-primary">Agregar sucursal</button></div>
      </div>
      <!-- Área administrativa: usuarios y gráficos (solo visible a admin) -->
      <div id="admin-usuarios-section" style="margin-top:18px;"></div>
    </section>
    </div>
  </main>

  <!-- Modal simple para agregar/editar -->
  <div class="modal" tabindex="-1" id="modal-producto">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="titulo-modal">Nuevo producto</h5>
          <button type="button" class="btn-close" id="cerrar-modal"></button>
        </div>
        <div class="modal-body">
          <form id="formulario-producto">
            <input type="hidden" id="producto-id">
            <div class="mb-2"><label>Nombre</label><input id="producto-nombre" class="form-control" required></div>
            <div class="mb-2"><label>URL imagen</label><input id="producto-imagen" class="form-control" required></div>
            <div class="mb-2"><label>Precio</label><input id="producto-precio" type="number" step="0.01" class="form-control" required></div>
            <div class="mb-2"><label>Cantidad</label><input id="producto-cantidad" type="number" class="form-control" required></div>
            <div class="mb-2"><label>Temporada</label>
              <select id="producto-temporada" class="form-select">
                <option value="normal">Normal</option>
                <option value="navideño">Navideño</option>
              </select>
            </div>
            <button class="btn btn-primary" type="submit">Guardar</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="/auth.js"></script>
  <script src="/main.js"></script>
  <script src="/sucursales.js"></script>
  <!-- Librerías para administración y generación de PDFs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="/add_fondos.js"></script>
  <script>
    // Esperar a que el DOM esté listo
    document.addEventListener('DOMContentLoaded', () => {
      // Verificar la autenticación cada segundo durante los primeros 5 segundos
      let intentos = 0;
      const intervalo = setInterval(async () => {
        const usuario = await verificarAutenticacion();
        console.log('Intento de verificación:', intentos + 1, usuario);
        // Mostrar fondos en esquina para usuarios normales
        if (usuario && usuario.usuario) {
          // Crear badge si no existe
          let badge = document.getElementById('user-fondos');
          if (!badge) {
            badge = document.createElement('div');
            badge.id = 'user-fondos';
            badge.style.position = 'fixed';
            badge.style.right = '12px';
            badge.style.bottom = '12px';
            badge.style.background = 'rgba(0,0,0,0.7)';
            badge.style.color = '#fff';
            badge.style.padding = '8px 12px';
            badge.style.borderRadius = '8px';
            badge.style.zIndex = '2000';
            document.body.appendChild(badge);
          }
          const fondos = usuario.fondos != null ? Number(usuario.fondos) : 0;
          badge.textContent = `Fondos: $${fondos.toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        if (usuario || intentos >= 5) {
          clearInterval(intervalo);
        }
        intentos++;
      }, 1000);
    });
  </script>
</body>
</html>
